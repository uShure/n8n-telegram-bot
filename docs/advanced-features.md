# –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏ –∫–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
1. [–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ä–æ–ª–µ–π](#–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ-–Ω–æ–≤—ã—Ö-—Ä–æ–ª–µ–π)
2. [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–º–ø—Ç–æ–≤](#–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-–ø—Ä–æ–º–ø—Ç–æ–≤)
3. [–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤](#–∏–∑–º–µ–Ω–µ–Ω–∏–µ-–ª–∏–º–∏—Ç–æ–≤)
4. [–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ÆKassa](#–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è-—Å-—ékassa)
5. [–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è](#–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ-–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è)
6. [–ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å](#–º—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å)
7. [Webhook –Ω–∞—Å—Ç—Ä–æ–π–∫–∏](#webhook-–Ω–∞—Å—Ç—Ä–æ–π–∫–∏)

## –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ä–æ–ª–µ–π

### 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ–Ω—é –≤ Telegram

–í –Ω–æ–¥–µ "Send Menu" –¥–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—É—é –∫–Ω–æ–ø–∫—É:

```json
{
  "row": {
    "buttons": [
      {
        "text": "üéØ –ù–æ–≤–∞—è —Ä–æ–ª—å",
        "callback_data": "role_newrole"
      }
    ]
  }
}
```

### 2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞

–í –Ω–æ–¥–µ "Prepare Prompt" –≤ –æ–±—ä–µ–∫—Ç `prompts` –¥–æ–±–∞–≤—å—Ç–µ:

```javascript
newrole: {
  system: "–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –Ω–æ–≤–æ–π —Ä–æ–ª–∏...",
  user: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç..."
}
```

### 3. –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ —Å –ø—Ä–æ–º–ø—Ç–æ–º

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `prompts/newrole.md` —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º.

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–º–ø—Ç–æ–≤

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø—Ä–æ–º–ø—Ç–æ–≤

1. **–ß–µ—Ä–µ–∑ n8n:**
   - –û—Ç–∫—Ä–æ–π—Ç–µ –Ω–æ–¥—É "Prepare Prompt"
   - –ò–∑–º–µ–Ω–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤ –æ–±—ä–µ–∫—Ç–µ `prompts`
   - –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ workflow

2. **–ß–µ—Ä–µ–∑ —Ñ–∞–π–ª—ã –ø—Ä–æ–º–ø—Ç–æ–≤:**
   - –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ `prompts/`
   - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–π—Ç–µ —Å –∫–æ–¥–æ–º –≤ n8n

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

–í –Ω–æ–¥–µ "DeepSeek API" –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å:

```json
{
  "temperature": 0.7,      // –ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å (0-1)
  "max_tokens": 2000,      // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞
  "top_p": 0.9,           // –†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ
  "frequency_penalty": 0   // –®—Ç—Ä–∞—Ñ –∑–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
}
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

–î–ª—è —É–ª—É—á—à–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç:

```javascript
messages: [
  {
    role: "system",
    content: systemPrompt
  },
  {
    role: "assistant",
    content: "–ü—Ä–∏–º–µ—Ä —Ö–æ—Ä–æ—à–µ–π –æ–±—ä—è—Å–Ω–∏—Ç–µ–ª—å–Ω–æ–π..."
  },
  {
    role: "user",
    content: userPrompt
  }
]
```

## –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤

### –ë–∞–∑–æ–≤—ã–π –ª–∏–º–∏—Ç

–í –Ω–æ–¥–µ "Check Limits" –∏–∑–º–µ–Ω–∏—Ç–µ —É—Å–ª–æ–≤–∏–µ:

```javascript
// –ë—ã–ª–æ: if (quota < 6)
if (quota < 10) // –ù–æ–≤—ã–π –ª–∏–º–∏—Ç: 10 –∑–∞–ø—Ä–æ—Å–æ–≤
```

### –î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–∏–º–∏—Ç—ã

–î–æ–±–∞–≤—å—Ç–µ –ª–æ–≥–∏–∫—É –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:

```javascript
let limit = 6; // –ë–∞–∑–æ–≤—ã–π –ª–∏–º–∏—Ç

// VIP –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
if (vipUsers.includes(userId)) {
  limit = 20;
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞
if (quota < limit) {
  // –†–∞–∑—Ä–µ—à–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
}
```

### –õ–∏–º–∏—Ç—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏

–î–æ–±–∞–≤—å—Ç–µ —Å–±—Ä–æ—Å –ª–∏–º–∏—Ç–æ–≤ —Ä–∞–∑ –≤ –¥–µ–Ω—å/–Ω–µ–¥–µ–ª—é:

```javascript
// –î–æ–±–∞–≤—å—Ç–µ –∫–æ–ª–æ–Ω–∫—É lastReset –≤ Google Sheets
const lastReset = new Date(userData.lastReset);
const now = new Date();

// –ï—Å–ª–∏ –ø—Ä–æ—à–ª–æ –±–æ–ª—å—à–µ —Å—É—Ç–æ–∫
if (now - lastReset > 24 * 60 * 60 * 1000) {
  // –°–±—Ä–æ—Å–∏—Ç—å —Å—á–µ—Ç—á–∏–∫
  quota = 0;
}
```

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ÆKassa

### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞

1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –≤ –ÆKassa
2. –ü–æ–ª—É—á–∏—Ç–µ shopId –∏ secretKey
3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### 2. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–¥—ã –¥–ª—è –æ–ø–ª–∞—Ç—ã

```javascript
// HTTP Request –Ω–æ–¥–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞
{
  "method": "POST",
  "url": "https://api.yookassa.ru/v3/payments",
  "authentication": "basicAuth",
  "credentials": {
    "user": "{{ $credentials.shopId }}",
    "password": "{{ $credentials.secretKey }}"
  },
  "body": {
    "amount": {
      "value": "299.00",
      "currency": "RUB"
    },
    "confirmation": {
      "type": "redirect",
      "return_url": "https://t.me/your_bot"
    },
    "description": "–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –±–æ—Ç–∞",
    "metadata": {
      "userId": "{{ $json.userId }}"
    }
  }
}
```

### 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ webhook –æ—Ç –ÆKassa

–°–æ–∑–¥–∞–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—ã–π workflow –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:

1. Webhook –Ω–æ–¥–∞ –¥–ª—è –ø—Ä–∏–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏
3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –≤ Google Sheets
4. –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

## –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

### 1. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –ª–æ–≥–æ–≤

–í Google Sheets —Å–æ–∑–¥–∞–π—Ç–µ –ª–∏—Å—Ç "Logs" —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏:
- timestamp
- userId
- action
- role
- status
- error

### 2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ –ª–æ–≥

–ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è –¥–æ–±–∞–≤—å—Ç–µ –Ω–æ–¥—É Google Sheets:

```javascript
{
  "operation": "append",
  "sheetName": "Logs",
  "fieldsUi": {
    "values": [
      {
        "column": "timestamp",
        "fieldValue": "{{ new Date().toISOString() }}"
      },
      {
        "column": "userId",
        "fieldValue": "{{ $json.userId }}"
      },
      {
        "column": "action",
        "fieldValue": "generate"
      },
      {
        "column": "status",
        "fieldValue": "success"
      }
    ]
  }
}
```

### 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—à–∏–±–æ–∫

–î–æ–±–∞–≤—å—Ç–µ Error Trigger –¥–ª—è –æ—Ç–ª–æ–≤–∞ –æ—à–∏–±–æ–∫:

```javascript
// –í Code –Ω–æ–¥–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
try {
  // –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
} catch (error) {
  // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏
  await logError(userId, error.message);

  // –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω—É
  await sendAdminNotification(error);

  throw error; // –ü—Ä–æ–±—Ä–æ—Å–∏—Ç—å –¥–∞–ª—å—à–µ
}
```

## –ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å

### 1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —è–∑—ã–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```javascript
// –í Check User –Ω–æ–¥–µ
const userLang = callbackData.from.language_code || 'ru';

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ Google Sheets
userData.language = userLang;
```

### 2. –ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã

```javascript
const prompts = {
  ru: {
    commander: { /* ... */ },
    witness: { /* ... */ }
  },
  en: {
    commander: { /* ... */ },
    witness: { /* ... */ }
  }
};

const userPrompts = prompts[userLang] || prompts.ru;
```

### 3. –ü–µ—Ä–µ–≤–æ–¥ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞

```javascript
const translations = {
  ru: {
    welcome: "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!",
    choose_role: "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å:",
    limit_reached: "–õ–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω"
  },
  en: {
    welcome: "Welcome!",
    choose_role: "Choose role:",
    limit_reached: "Limit reached"
  }
};

const t = translations[userLang] || translations.ru;
```

## Webhook –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### Production webhook

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ webhook
curl -X POST "https://api.telegram.org/bot{TOKEN}/setWebhook" \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://your-n8n.com/webhook/telegram-bot",
    "max_connections": 40,
    "allowed_updates": ["message", "callback_query"]
  }'
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook

```bash
# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ webhook
curl "https://api.telegram.org/bot{TOKEN}/getWebhookInfo"
```

### –£–¥–∞–ª–µ–Ω–∏–µ webhook (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)

```bash
curl "https://api.telegram.org/bot{TOKEN}/deleteWebhook"
```

## –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### 1. –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Static Data –≤ n8n –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö:

```javascript
// –í –Ω–∞—á–∞–ª–µ workflow
const staticData = $getWorkflowStaticData('global');

// –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤
if (!staticData.prompts) {
  staticData.prompts = loadPrompts();
}
```

### 2. –ë–∞—Ç—á–∏–Ω–≥ –∑–∞–ø—Ä–æ—Å–æ–≤

–ü—Ä–∏ –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ batch API Google Sheets:

```javascript
// –í–º–µ—Å—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
const batchData = users.map(user => ({
  range: `A${user.row}:E${user.row}`,
  values: [[user.userId, user.chatId, user.role, user.quota, user.sub]]
}));

// –û–¥–∏–Ω –∑–∞–ø—Ä–æ—Å
await sheets.batchUpdate(batchData);
```

### 3. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞

–î–ª—è –¥–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ SplitInBatches –Ω–æ–¥—É:

- Batch Size: 10
- –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞ —á–∞—Å—Ç–∏
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Ç–∞–π–º–∞—É—Ç–æ–≤
